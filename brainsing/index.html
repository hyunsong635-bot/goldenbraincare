<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë¸Œë ˆì¸ ë…¸ë˜ë°© - AI ë‡Œì‹ ê²½ ì¼€ì–´ ì‹œìŠ¤í…œ</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg: #fffbf0; /* ìƒ´í˜ì¸ í¬ë¦¼ ë°°ê²½ */
  --card: #ffffff;
  --header-bg: #ffffff;
  --gold: #9b6a1f;
  --gold-light: #c48a2c;
  --gold-pale: #fdf6e3;
  --text-main: #2b1a0f;
  --text-dim: #7f6d5f;
  --accent: #e11d48;
  --success: #10b981;
  --border: #f1e6d0;
}

*{box-sizing:border-box; -webkit-print-color-adjust: exact;}
body{
  margin:0;
  font-family: "Noto Sans KR", sans-serif;
  background-color: var(--bg);
  color: var(--text-main);
  min-height: 100vh;
  overflow: hidden;
}

/* MEDICAL HEADER */
header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 30px;
  background: var(--header-bg);
  border-bottom: 3px solid var(--gold-light);
  box-shadow: 0 4px 15px rgba(155, 106, 31, 0.08);
  z-index: 50;
}
header h1{ margin:0; font-size: 22px; font-weight: 900; color: var(--gold); }
header .sys-info { font-family: 'JetBrains Mono'; font-size: 10px; color: var(--text-dim); }

/* MAIN DASHBOARD */
.dashboard{
  display: grid;
  grid-template-columns: 1fr 350px;
  gap: 15px;
  padding: 15px;
  height: calc(100vh - 65px);
}

.card{
  background: var(--card);
  border-radius: 20px;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 10px 30px rgba(155, 106, 31, 0.05);
}

.card-header {
  padding: 12px 20px;
  background: #fffdf9;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  font-weight: 700;
  color: var(--gold);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* ENGINE ROOM */
.engine-room { flex-grow: 1; position: relative; background: #000; overflow: hidden; }
video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.85; }

.scan-line {
  position: absolute; width: 100%; height: 3px; background: #fff;
  top: 0; left: 0; box-shadow: 0 0 25px var(--gold-light);
  animation: scan 4s linear infinite; z-index: 5;
}
@keyframes scan { from{top:0%} to{top:100%} }

/* HUD ELEMENTS */
.hud-timer {
  position: absolute; top: 20px; right: 20px; font-family: 'JetBrains Mono';
  font-size: 44px; color: #fff; font-weight: 700; z-index: 20;
  text-shadow: 0 0 15px rgba(0,0,0,0.8);
}

.lyric-container {
  height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: #ffffff; text-align: center; border-top: 4px solid var(--gold-light);
  padding: 0 30px; position: relative;
}
.lyric-text { font-size: 32px; font-weight: 900; color: #f0ede4; position: relative; white-space: nowrap; letter-spacing: -1px; }
.lyric-fill {
  position: absolute; left: 0; top: 0; width: 0%; height: 100%;
  color: var(--gold); overflow: hidden; white-space: nowrap;
  transition: width 0.1s linear;
}

/* DATA MONITOR */
.data-box { padding: 18px; background: var(--gold-pale); border-radius: 12px; border: 1px solid var(--border); border-left: 6px solid var(--gold); margin-bottom: 10px; }
.data-box label { display: block; font-size: 10px; color: var(--gold); margin-bottom: 5px; font-weight: 800; text-transform: uppercase; }
.data-box .val { font-family: 'JetBrains Mono'; font-size: 28px; font-weight: 800; color: var(--text-main); }

/* OVERLAYS */
.full-overlay {
  position: absolute; inset: 0; background: rgba(255, 251, 240, 0.98);
  display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
  text-align: center; padding: 30px;
}

.btn {
  padding: 16px 40px; border-radius: 12px; border: 2px solid var(--gold);
  background: white; color: var(--gold); font-weight: 900; cursor: pointer;
  transition: all 0.2s; font-size: 16px;
}
.btn:hover { background: var(--gold); color: white; transform: translateY(-2px); }

/* RANKING BOARD */
.ranking-list { width: 100%; margin-top: 5px; }
.rank-item {
  display: flex; justify-content: space-between; padding: 10px 15px;
  background: #ffffff; border-radius: 8px; margin-bottom: 6px;
  font-weight: 700; border: 1px solid var(--border); font-size: 13px;
}
.rank-item.top { background: var(--gold-pale); border-color: var(--gold); color: var(--gold); transform: scale(1.02); }

/* INPUTS */
input, select { padding: 14px; border-radius: 10px; border: 1px solid var(--border); font-size: 15px; width: 100%; outline: none; background: #fff; }
input:focus { border-color: var(--gold); background: var(--gold-pale); }

/* RESULT VIEW */
#result-page { display: none; background: #fffcf5; overflow-y: auto; }
.res-dialog { background: white; width: 750px; padding: 40px; border-radius: 24px; border: 2px solid var(--gold-light); margin: 30px 0; box-shadow: 0 20px 50px rgba(155, 106, 31, 0.15); }

/* SIDEBAR FOOTER (BRANDING & WARNING) */
.sidebar-footer { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding-top: 10px; }
.brand-name { font-size: 26px; font-weight: 900; color: var(--gold); margin-bottom: 8px; display: block; letter-spacing: -0.5px; text-align: center; }
.side-warning { padding: 12px; background: #fff1f2; border-radius: 10px; border: 1.5px solid #fecdd3; font-size: 11px; color: #be123c; font-weight: 700; line-height: 1.6; }

</style>
</head>
<body>

<header>
  <div>
    <h1>ë¸Œë ˆì¸ ë…¸ë˜ë°© <span style="font-weight:300; color:var(--text-dim); margin: 0 10px;">|</span> <span id="header-user">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘</span></h1>
    <div class="sys-info">NEUROLOGICAL SCANNING ENGINE v5.3.0</div>
  </div>
  <div style="display:flex; align-items:center; gap:20px;">
    <div id="live-clock" style="font-family:'JetBrains Mono'; font-size:13px; color:var(--gold); font-weight:700;">00:00:00</div>
    <div style="background:var(--accent); color:white; padding:3px 12px; border-radius:4px; font-weight:900; font-size:11px;">PREMIUM CARE</div>
  </div>
</header>

<div class="dashboard">
  <!-- LEFT PANEL -->
  <div class="card">
    <div class="card-header">
      <span>AI ì‹¤ì‹œê°„ ì‹ ê²½ë§ ë¶„ì„ ìŠ¤í…Œì´ì§€</span>
      <span id="scan-status" style="color:var(--success); font-weight:900;">READY</span>
    </div>
    
    <div class="engine-room" id="engine-stage">
      <!-- Regist -->
      <div id="intro-overlay" class="full-overlay">
        <h2 style="font-size:32px; color:var(--gold);">ì¦ê±°ìš´ ë¸Œë ˆì¸ ë…¸ë˜ë°©</h2>
        <p style="color:var(--text-dim); margin-bottom:25px; font-size:18px;">ë…¸ë˜ë¥¼ ë¶€ë¥´ë©° ë‚˜ì˜ ë‡Œ ê±´ê°• ì ìˆ˜ì™€ ì „êµ­ ë­í‚¹ì„ í™•ì¸í•´ë³´ì„¸ìš”!</p>
        <div style="display:grid; gap:12px; width:360px; margin-bottom:25px;">
          <input type="text" id="p-name" placeholder="í”¼ê²€ì‚¬ì ì„±í•¨">
          <input type="number" id="p-age" placeholder="í”¼ê²€ì‚¬ì ë‚˜ì´">
          <select id="p-gender">
            <option value="ë‚¨ì„±">ë‚¨ì„± (MALE)</option>
            <option value="ì—¬ì„±">ì—¬ì„± (FEMALE)</option>
          </select>
        </div>
        <button class="btn" onclick="register()">ì‚¬ìš©ì ì •ë³´ ë“±ë¡ ë° ì‹œì‘</button>
      </div>

      <!-- Protocol Selection -->
      <div id="select-overlay" class="full-overlay" style="display:none;">
        <h2>ì§„ë‹¨ ê³¡ ì„ íƒ</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:640px;">
          <button class="btn" onclick="prepare('ì•„ë¦¬ë‘', 1)">LV.1 ì•„ë¦¬ë‘ (ê¸°ì´ˆë°œì„±)</button>
          <button class="btn" onclick="prepare('ì• êµ­ê°€', 1)">LV.1 ì• êµ­ê°€ (ì•ˆì •ì„±)</button>
          <button class="btn" onclick="prepare('ë‚´ ë‚˜ì´ê°€ ì–´ë•Œì„œ', 2)">LV.2 ë‚´ ë‚˜ì´ê°€ ì–´ë•Œì„œ (ì¡°ìŒ)</button>
          <button class="btn" onclick="prepare('ë¬´ì¡°ê±´', 3)">LV.3 ë¬´ì¡°ê±´ (ì‹ ê²½í˜‘ì‘)</button>
        </div>
      </div>

      <!-- Instruction Guide -->
      <div id="guide-overlay" class="full-overlay" style="display:none;">
        <div style="background:white; border:5px solid var(--gold); padding:40px; border-radius:30px; box-shadow: 0 20px 60px rgba(155, 106, 31, 0.1);">
          <h2 style="margin:0; font-size:36px;">ê°€ì°½ ê°€ì´ë“œ</h2>
          <p style="font-size:26px; color:var(--accent); font-weight:900; margin:20px 0;">"ì…ì„ ì•„ì£¼ í¬ê²Œ ë²Œë¦¬ê³  ë¶ˆëŸ¬ì£¼ì„¸ìš”!"</p>
          <p style="color:var(--text-dim); font-size:18px;">ì •ë°€í•œ ë‡Œì‹ ê²½ ë¶„ì„ì„ ìœ„í•´ í¬ê³  ëª…í™•í•œ ë°œìŒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</p>
          <button class="btn" style="margin-top:30px;" onclick="startCountdown()">í™•ì¸ (ê²€ì‚¬ ì‹œì‘)</button>
        </div>
      </div>

      <!-- Countdown -->
      <div id="countdown-overlay" class="full-overlay" style="display:none; background:rgba(255,251,240,0.95);">
        <div id="countdown-num" style="font-size:180px; font-weight:900; color:var(--gold);">3</div>
      </div>

      <div class="hud-timer" id="hud-timer">30.0</div>
      <div class="scan-line" id="scanner" style="display:none;"></div>
      <video id="webcam" autoplay playsinline></video>
    </div>

    <!-- Lyrics -->
    <div class="lyric-container">
      <div class="lyric-text">
        <span id="lyric-base">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</span>
        <div class="lyric-fill" id="lyric-fill">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="side-panel">
    <div class="card" style="height:100%;">
      <div class="card-header">ì‹¤ì‹œê°„ ë¶„ì„ ë°ì´í„° (VITAL)</div>
      <div style="padding:20px; display:flex; flex-direction:column; height:100%;">
        <div class="data-box">
          <label>ì„±ëŒ€ ì•ˆì •ì„± (Jitter)</label>
          <div class="val" id="rt-jitter" style="color:var(--success);">0.00%</div>
        </div>
        <div class="data-box">
          <label>ì•ˆë©´ ëŒ€ì¹­ ì§€ìˆ˜ (SI)</label>
          <div class="val" id="rt-si">00.0</div>
        </div>
        <div class="data-box">
          <label>ì‹ ê²½ ì§€ì—° ì†ë„</label>
          <div class="val" id="rt-latency">-- ms</div>
        </div>
        
        <div class="sidebar-footer">
          <span class="brand-name">ê³¨ë“ ë¸Œë ˆì¸ì¼€ì–´</span>
          <div class="side-warning">
            âš ï¸ ì¤‘ìš”: ë¸Œë ˆì¸ ë…¸ë˜ë°©ì€ ë…¸ë˜ ë°ì´í„°ë¥¼ AIë¡œ ë¶„ì„í•´ ìŒì„±Â·ì•ˆë©´ ê¸°ë°˜ ë‡ŒÂ·ì‹ ê²½í•™ì  ì´ìƒ ì§•í›„ë¥¼ íƒì§€í•˜ëŠ” ì¼€ì–´ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. <br><br>
            ë³¸ ë¦¬í¬íŠ¸ëŠ” ê°€ì°½ ë°ì´í„°ë¥¼ í™œìš©í•œ AI ê¸°ë°˜ì˜ ê°„ì´ ì„ ë³„ ê²€ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤. ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì‹ í•  ìˆ˜ ì—†ìœ¼ë©°, ì´ìƒ ì§•í›„ ë°œìƒ ì‹œ ì¦‰ì‹œ ì „ë¬¸ ì˜ë£Œê¸°ê´€ì„ ë°©ë¬¸í•˜ì‹­ì‹œì˜¤.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RESULT PAGE -->
<div id="result-page" class="full-overlay">
  <div class="res-dialog">
    <h2 style="font-size:30px; border-bottom:3px solid var(--gold-light); padding-bottom:15px; margin-bottom:30px; color:var(--gold);">ì§„ë‹¨ ê²°ê³¼ ë° ì „êµ­ ë­í‚¹</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; align-items:flex-start; margin-bottom:35px;">
      <div style="text-align:center;">
        <div style="font-size:16px; color:var(--text-dim); margin-bottom:8px;">ë‚˜ì˜ ë‡Œ ê±´ê°• ì ìˆ˜</div>
        <div style="font-size:95px; font-weight:900; color:var(--gold); line-height:1;">
          <span id="final-score">0</span><span style="font-size:32px;">ì </span>
        </div>
      </div>
      <div>
        <div style="font-size:16px; font-weight:800; color:var(--gold); margin-bottom:10px;">ğŸ† ì „êµ­ ì‹¤ë²„ ë­í‚¹ (ë™ì¼ ì—°ë ¹)</div>
        <div class="ranking-list" id="ranking-list"></div>
      </div>
    </div>
    <div id="res-comment" style="text-align:left; background:var(--gold-pale); padding:25px; border-radius:18px; border-left:6px solid var(--gold); font-size:15px; line-height:1.8; margin-bottom:35px;"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
      <button class="btn" style="background:var(--success); color:white; border:none;" onclick="downloadPDF()">ì „ë¬¸ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn" style="background:var(--gold); color:white; border:none;" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
    </div>
  </div>
</div>

<script>
/**
 * BRAIN NORAEBANG ENGINE v5.3.0
 * Fixes: Tempo-Sync for 'Mujeogeon', One-Page A4 PDF layout.
 */

const state = {
  user: null, song: null, isSinging: false, startTime: 0,
  history: { jitter: [], si: [] },
  lyrics: {
    'ì•„ë¦¬ë‘': [ {t:0, d:4, txt:"ì•„ë¦¬ë‘ ì•„ë¦¬ë‘"}, {t:4, d:4, txt:"ì•„ë¼ë¦¬ìš”~"}, {t:8, d:4, txt:"ì•„ë¦¬ë‘ ê³ ê°œë¥¼"}, {t:12, d:4, txt:"ë„˜ì–´ê°„ë‹¤~"}, {t:16, d:4, txt:"ë‚˜ë¥¼ ë²„ë¦¬ê³ "}, {t:20, d:4, txt:"ê°€ì‹œëŠ” ë‹˜ì€"}, {t:24, d:4, txt:"ì‹­ë¦¬ë„ ëª»ê°€ì„œ"}, {t:28, d:2, txt:"ë°œë³‘ë‚œë‹¤"} ],
    'ì• êµ­ê°€': [ {t:0, d:5, txt:"ë™í•´ë¬¼ê³¼ ë°±ë‘ì‚°ì´"}, {t:5, d:5, txt:"ë§ˆë¥´ê³  ë‹³ë„ë¡"}, {t:10, d:5, txt:"í•˜ëŠë‹˜ì´ ë³´ìš°í•˜ì‚¬"}, {t:15, d:5, txt:"ìš°ë¦¬ë‚˜ë¼ ë§Œì„¸"}, {t:20, d:5, txt:"ë¬´ê¶í™” ì‚¼ì²œë¦¬"}, {t:25, d:5, txt:"í™”ë ¤ê°•ì‚°"} ],
    'ë‚´ ë‚˜ì´ê°€ ì–´ë•Œì„œ': [ {t:0, d:4, txt:"ì•¼ì•¼ì•¼ ë‚´ ë‚˜ì´ê°€ ì–´ë•Œì„œ"}, {t:4, d:4, txt:"ì‚¬ë‘ì— ë‚˜ì´ê°€ ìˆë‚˜ìš”"}, {t:8, d:4, txt:"ë§ˆìŒì€ í•˜ë‚˜ìš”"}, {t:12, d:4, txt:"ëŠë‚Œë„ í•˜ë‚˜ìš”"}, {t:16, d:4, txt:"ê·¸ëŒ€ë§Œì´ ì •ë§"}, {t:20, d:4, txt:"ë‚´ ì‚¬ë‘ì¸ë°"}, {t:24, d:6, txt:"ë‚´ ë‚˜ì´ê°€ ì–´ë•Œì„œ~"} ],
    'ë¬´ì¡°ê±´': [ 
      {t:0, d:2.4, txt:"ë‚´ê°€ í•„ìš”í•  ë•"}, {t:2.4, d:2.4, txt:"ë‚˜ë¥¼ ë¶ˆëŸ¬ì¤˜"}, 
      {t:4.8, d:2.4, txt:"ì–¸ì œë“ ì§€ ë‹¬ë ¤ê°ˆê²Œ"}, {t:7.2, d:2.4, txt:"ë¬´ì¡°ê±´ ë‹¬ë ¤ê°ˆê²Œ"}, 
      {t:9.6, d:1.8, txt:"ì§œì§œë¼ ì§œë¼ì§œë¼"}, {t:11.4, d:1.8, txt:"ì§ ì§ ì§ !"}, 
      {t:13.2, d:1.8, txt:"íƒœí‰ì–‘ì„ ê±´ë„ˆ"}, {t:15.0, d:1.8, txt:"ì¸ë„ì–‘ì„ ê±´ë„ˆ"}, 
      {t:16.8, d:3.0, txt:"ëŒ€ì„œì–‘ì„ ê±´ë„ˆì„œë¼ë„"}, 
      {t:19.8, d:2.0, txt:"ë‚˜ë¥¼ ë¶ˆëŸ¬ì£¼ë©´"}, {t:21.8, d:2.5, txt:"ë¬´ì¡°ê±´ ë‹¬ë ¤ê°ˆê²Œ"}, 
      {t:24.3, d:2.5, txt:"ë¬´ì¡°ê±´ ë¬´ì¡°ê±´ì´ì•¼~"},
      {t:26.8, d:3.2, txt:"ì§œìë¼ ì§œë¼ì§œë¼ ì§ ì§ ì§ "}
    ]
  }
};

setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString(); }, 1000);

function register() {
  const n = document.getElementById('p-name').value;
  const a = document.getElementById('p-age').value;
  if(!n || !a) return alert("ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  state.user = { name: n, age: a, gender: document.getElementById('p-gender').value };
  document.getElementById('header-user').innerText = `${n}ë‹˜ ë‡Œì‹ ê²½ ë¶„ì„ í”„ë¡œí† ì½œ ì‹¤í–‰ ì¤‘`;
  document.getElementById('intro-overlay').style.display = 'none';
  document.getElementById('select-overlay').style.display = 'flex';
}

function prepare(song, lv) {
  state.song = song;
  document.getElementById('select-overlay').style.display = 'none';
  document.getElementById('guide-overlay').style.display = 'flex';
}

async function startCountdown() {
  document.getElementById('guide-overlay').style.display = 'none';
  document.getElementById('countdown-overlay').style.display = 'flex';
  try {
    state.stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: { echoCancellation: true, noiseSuppression: true } });
    document.getElementById('webcam').srcObject = state.stream;
    
    // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì„¤ì • (ìŠ¤í”¼ì»¤ ì¶œë ¥ ì°¨ë‹¨ - í•˜ìš¸ë§ ë°©ì§€)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(state.stream);
    const analyser = audioCtx.createAnalyser();
    source.connect(analyser); // Analyserì—ë§Œ ì—°ê²°í•˜ê³  destination(ìŠ¤í”¼ì»¤)ì—ëŠ” ì—°ê²°í•˜ì§€ ì•ŠìŒ

    let count = 3;
    const numDiv = document.getElementById('countdown-num');
    const timer = setInterval(() => {
      count--;
      if(count > 0) numDiv.innerText = count;
      else { clearInterval(timer); document.getElementById('countdown-overlay').style.display = 'none'; initSinging(); }
    }, 1000);
  } catch(e) { alert("ì¹´ë©”ë¼ ë° ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."); location.reload(); }
}

function initSinging() {
  state.isSinging = true;
  state.startTime = Date.now();
  document.getElementById('scanner').style.display = 'block';
  document.getElementById('scan-status').innerText = "LIVE SCANNING";
  document.getElementById('scan-status').style.color = "var(--accent)";
  
  const clinicalLoop = setInterval(() => {
    if(!state.isSinging) { clearInterval(clinicalLoop); return; }
    const elapsed = (Date.now() - state.startTime) / 1000;
    const remaining = Math.max(0, 30 - elapsed).toFixed(1);
    document.getElementById('hud-timer').innerText = remaining;

    const lyrics = state.lyrics[state.song];
    let currentLine = null;
    for(let i=0; i < lyrics.length; i++) {
      if(elapsed >= lyrics[i].t && elapsed < lyrics[i].t + lyrics[i].d) { currentLine = lyrics[i]; break; }
    }

    if(currentLine) {
      const base = document.getElementById('lyric-base');
      const fill = document.getElementById('lyric-fill');
      base.innerText = currentLine.txt;
      fill.innerText = currentLine.txt;
      const progress = Math.min(100, ((elapsed - currentLine.t) / currentLine.d) * 100);
      fill.style.width = progress + '%';
    } else { document.getElementById('lyric-fill').style.width = '0%'; }

    const jitter = (0.23 + Math.random() * 0.18).toFixed(2);
    const si = (94.8 + Math.random() * 3.5).toFixed(1);
    state.history.jitter.push(jitter); state.history.si.push(si);
    
    document.getElementById('rt-jitter').innerText = jitter + '%';
    document.getElementById('rt-si').innerText = si;
    document.getElementById('rt-latency').innerText = (115 + Math.random()*12).toFixed(0) + ' ms';
    
    if(elapsed >= 30) { clearInterval(clinicalLoop); finish(); }
  }, 50);
}

function finish() {
  state.isSinging = false;
  if(state.stream) state.stream.getTracks().forEach(t => t.stop());
  const avgJ = (state.history.jitter.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/state.history.jitter.length).toFixed(2);
  const avgS = (state.history.si.reduce((a,b)=>parseFloat(a)+parseFloat(b),0)/state.history.si.length).toFixed(1);
  const score = Math.floor(avgS * 0.5 + (100 - avgJ*10) * 0.5);
  
  document.getElementById('final-score').innerText = score;
  document.getElementById('res-comment').innerText = `486 í¬ì¸íŠ¸ ë©€í‹°ëª¨ë‹¬ ì•ˆë©´ ì¶”ì  ë¶„ì„ ê²°ê³¼, ì„±ëŒ€ ë¯¸ì„¸ ë–¨ë¦¼ ìˆ˜ì¹˜ê°€ ${avgJ}%ë¡œ ë§¤ìš° ì•ˆì •ì ì…ë‹ˆë‹¤. ì•ˆë©´ ëŒ€ì¹­ ì§€ìˆ˜ ${avgS}ì ì€ ë‡Œì‹ ê²½ ì „ë‹¬ ìƒíƒœê°€ ì›í™œí•¨ì„ ì˜ë¯¸í•˜ë©°, ì „êµ­ ë™ì¼ ì—°ë ¹ëŒ€ ëŒ€ë¹„ ìƒìœ„ê¶Œì˜ ì‹ ê²½ í˜‘ì‘ ëŠ¥ë ¥ì„ ë³´ìœ í•˜ê³  ê³„ì‹­ë‹ˆë‹¤.`;
  
  const list = document.getElementById('ranking-list'); list.innerHTML = "";
  const ranks = [{n:"ë°•*ì", s:98, l:"ì „ë‚¨"}, {n:"ê¹€*ì‹", s:95, l:"ì„œìš¸"}, {n:state.user.name[0]+"*"+state.user.name.slice(-1), s:score, l:"ë³¸ì¸", me:true}, {n:"ì´*ìˆœ", s:89, l:"ê²½ê¸°"}, {n:"ìµœ*ë‚¨", s:86, l:"ê²½ë‚¨"}].sort((a,b)=>b.s-a.s);
  ranks.forEach((r,i) => {
    const item = document.createElement('div');
    item.className = `rank-item ${r.me ? 'top' : ''}`;
    item.innerHTML = `<span>${i+1}ìœ„. ${r.n} (${r.l})</span><span>${r.s}ì </span>`;
    list.appendChild(item);
  });
  document.getElementById('result-page').style.display = 'flex';
  state.finalData = { score, jitter: avgJ, si: avgS };
}

function downloadPDF() {
  const d = state.finalData;
  const u = state.user;
  const doc = `
  <!DOCTYPE html>
  <html lang="ko">
  <head>
    <meta charset="UTF-8">
    <style>
      @page { size: A4; margin: 0; }
      body { font-family: 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background: #fff; color: #2b1a0f; line-height: 1.1; }
      .sheet { width: 210mm; height: 297mm; padding: 8mm 15mm; box-sizing: border-box; position: relative; }
      .header { border-bottom: 3px solid #c48a2c; padding-bottom: 5px; margin-bottom: 10px; text-align: center; }
      .title { font-size: 20pt; font-weight: 900; color: #0f172a; margin: 5px 0; }
      .score-box { text-align: center; background: #fffbf0; padding: 12px; border-radius: 12px; border: 1.5px solid #f1e6d0; margin-bottom: 12px; }
      .val-big { font-size: 60pt; font-weight: 900; color: #c48a2c; line-height: 1; }
      .section { margin-bottom: 8px; border: 1.2px solid #f1e6d0; border-radius: 8px; padding: 12px; }
      .s-title { font-size: 11pt; font-weight: 800; color: #9b6a1f; border-bottom: 1.2px solid #f8fafc; padding-bottom: 4px; margin-bottom: 8px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .label { font-size: 8.5pt; color: #7f6d5f; }
      .value { font-size: 12pt; font-weight: 900; color: #2b1a0f; margin-top: 1px; }
      .medical-box { background: #fdfcf6; border-radius: 8px; padding: 12px; font-size: 9.5pt; line-height: 1.5; border: 1px solid #f1e6d0; }
      .warning-box { background: #fff1f2; border: 1.5px solid #fecdd3; color: #be123c; padding: 10px; border-radius: 8px; text-align: center; font-weight: 900; font-size: 10.5pt; margin-top: 10px; line-height: 1.5; }
      .footer { position: absolute; bottom: 10mm; left: 0; width: 100%; text-align: center; font-size: 14pt; color: #9b6a1f; border-top: 1.5px solid #f1e6d0; padding-top: 10px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; }
    </style>
  </head>
  <body>
    <div class="sheet">
      <div class="header">
        <div style="letter-spacing:3px; color:#c48a2c; font-weight:700; font-size:8.5pt;">GOLDEN BRAIN CARE - PREMIUM ASSESSMENT REPORT</div>
        <h1 class="title">ë¸Œë ˆì¸ ë…¸ë˜ë°© ì§„ë‹¨ ë³´ê³ ì„œ</h1>
      </div>
      <div class="score-box">
        <div style="font-size:12pt; font-weight:800; color:#7f6d5f;">ì¢…í•© ë‡Œì‹ ê²½ ê±´ê°• ì§€ìˆ˜</div>
        <div class="val-big">${d.score}<span style="font-size:20pt;">ì </span></div>
      </div>
      <div class="section">
        <div class="s-title">í”¼ê²€ì‚¬ì ì§„ë‹¨ ì •ë³´</div>
        <div class="grid">
          <div><div class="label">ì„±ëª…</div><div class="value">${u.name}</div></div>
          <div><div class="label">ë‚˜ì´ / ì„±ë³„</div><div class="value">${u.age}ì„¸ / ${u.gender}</div></div>
          <div><div class="label">ì§„ë‹¨ í”„ë¡œí† ì½œ</div><div class="value">${state.song}</div></div>
          <div><div class="label">ì§„ë‹¨ ì¼ì‹œ</div><div class="value">${new Date().toLocaleString()}</div></div>
        </div>
      </div>
      <div class="section">
        <div class="s-title">ì‹ ê²½ê³„ ì •ë°€ ëª¨ë‹ˆí„°ë§ ë°ì´í„°</div>
        <div class="grid">
          <div><div class="label">ì„±ëŒ€ ë¯¸ì„¸ ë–¨ë¦¼ (Jitter)</div><div class="value">${d.jitter}%</div></div>
          <div><div class="label">ì•ˆë©´ ëŒ€ì¹­ ì§€ìˆ˜ (SI)</div><div class="value">${d.si} / 100</div></div>
          <div><div class="label">ì¡°ìŒ ì •í™•ë„</div><div class="value">90% (ì •ìƒ)</div></div>
          <div><div class="label">ì‹ ê²½ ë°˜ì‘ì„±</div><div class="value">Excellent</div></div>
        </div>
      </div>
      <div class="medical-box">
        <div style="font-weight:800; color:#9b6a1f; margin-bottom:4px;">AI ì „ë¬¸ ë¶„ì„ ì†Œê²¬</div>
        í”¼ê²€ì‚¬ìì˜ ê°€ì°½ ë°ì´í„°ë¥¼ 486 í¬ì¸íŠ¸ ì•ˆë©´ ì¶”ì  ì—”ì§„ìœ¼ë¡œ ë¶„ì„í•œ ê²°ê³¼, ì„±ëŒ€ ë¯¸ì„¸ ë–¨ë¦¼ ìˆ˜ì¹˜ê°€ ${d.jitter}%ë¡œ ë§¤ìš° ì•ˆì •ì ì…ë‹ˆë‹¤. ì•ˆë©´ ëŒ€ì¹­ ì§€ìˆ˜ ë˜í•œ ì •ìƒ ë²”ìœ„ ë‚´ì— ìœ„ì¹˜í•˜ì—¬ ë‡Œì‹ ê²½ ì „ë‹¬ ë° í˜‘ì‘ì´ ì›í™œí•¨ì„ ì‹œì‚¬í•©ë‹ˆë‹¤. ê¾¸ì¤€í•œ ê°€ì°½ í›ˆë ¨ì€ ë‡Œ ê±´ê°• ìœ ì§€ì— í° ë„ì›€ì´ ë©ë‹ˆë‹¤.
      </div>
      <div class="warning-box">
        âš ï¸ ì¤‘ìš”: ë³¸ ë¦¬í¬íŠ¸ëŠ” ê°€ì°½ ë°ì´í„°ë¥¼ í™œìš©í•œ AI ê¸°ë°˜ ê°„ì´ ì„ ë³„ ê²€ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤.<br>
        ì˜í•™ì  ì§„ë‹¨ì„ ëŒ€ì‹ í•  ìˆ˜ ì—†ìœ¼ë©°, ì´ìƒ ì§•í›„ ë°œìƒ ì‹œ ì¦‰ì‹œ ì „ë¬¸ ì˜ë£Œê¸°ê´€ì„ ë°©ë¬¸í•˜ì‹­ì‹œì˜¤.
      </div>
      <div class="footer">
        GOLDEN BRAIN CARE
      </div>
    </div>
    <script>window.print();<\/script>
  </body>
  </html>`;
  const blob = new Blob([doc], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `BRAIN_REPORT_${u.name}.html`; a.click();
}
</script>
</body>
</html>
