<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>브레인톡톡 - 디지털 K-WAB 언어재활 통합 엔진</title>
    
    <!-- 필수 라이브러리 로드 순서 최적화 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #F4F9FF; /* 눈이 편안한 연한 파란색 배경 */
            color: #1E293B;
            margin: 0;
            overflow-x: hidden;
        }

        .mirror { transform: scaleX(-1); }
        
        /* 스크롤바 디자인 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F4F9FF; }
        ::-webkit-scrollbar-thumb { background: #BFDBFE; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3B82F6; }

        /* --- PDF 인쇄/출력 최적화 (A4 2장 분량) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; visibility: visible !important; }
            
            .report-page {
                width: 210mm;
                height: 297mm;
                padding: 15mm 20mm;
                margin: 0 auto;
                background: white !important;
                color: black !important;
                position: relative;
                box-sizing: border-box;
                border: none !important;
                page-break-after: always;
                overflow: hidden;
            }

            /* 텍스트 겹침 방지 및 가독성 최적화 */
            .bg-blue-50, .bg-slate-50, .bg-slate-100 { 
                background: #f8fafc !important; 
                border: 1px solid #e2e8f0 !important; 
            }
            .text-blue-600 { color: #2563eb !important; }
            .text-slate-900 { color: #0f172a !important; }
            h1, h2, h3, h4, p, span { line-height: 1.4 !important; }
            
            /* 차트 인쇄 가독성 */
            .recharts-wrapper { max-width: 100% !important; filter: contrast(1.1); }
        }

        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        /**
         * 오류 해결된 Icon 컴포넌트
         * 라이브러리 직접 조작을 피하고 격리된 컨테이너에서 아이콘을 생성하여 주입합니다.
         */
        const Icon = ({ name, size = 24, className = "", color = "currentColor", fill = "none" }) => {
            const containerRef = useRef(null);
            
            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    // 내부 노드를 비우고 새 아이콘 태그 생성
                    const iconElement = document.createElement('div');
                    const iTag = document.createElement('i');
                    iTag.setAttribute('data-lucide', name);
                    iconElement.appendChild(iTag);
                    
                    window.lucide.createIcons({
                        attrs: {
                            width: size,
                            height: size,
                            stroke: color,
                            fill: fill,
                            class: className,
                            'stroke-width': 2.5
                        },
                        icons: { [name]: window.lucide.icons[name] },
                        root: iconElement
                    });
                    
                    containerRef.current.innerHTML = iconElement.innerHTML;
                }
            }, [name, size, color, fill, className]);

            return <span ref={containerRef} className="inline-flex items-center justify-center pointer-events-none"></span>;
        };

        const CLINICAL_PROTOCOLS = {
          STANDARD: {
            title: "LEVEL 1. 종합 실어증 지수 선별",
            subtitle: "K-WAB AQ 통합 예측 모드",
            items: [
              { id: 1, task: "사과", category: "명칭대기" }, { id: 2, task: "자동차", category: "명칭대기" },
              { id: 3, task: "안경", category: "명칭대기" }, { id: 4, task: "전화기", category: "명칭대기" },
              { id: 5, task: "어머니", category: "따라말하기" }, { id: 6, task: "선생님", category: "따라말하기" },
              { id: 7, task: "코끼리", category: "따라말하기" }, { id: 8, task: "대한민국", category: "따라말하기" },
              { id: 9, task: "밥을 [먹어요]", category: "문장완성" }, { id: 10, task: "학교에 [갑니다]", category: "문장완성" },
              { id: 11, task: "잠을 [자요]", category: "문장완성" }, { id: 12, task: "옷을 [입어요]", category: "문장완성" },
              { id: 13, task: "비가 오면 [우산을] 써요", category: "문장완성" }, { id: 14, task: "오늘 날씨가 정말 좋습니다", category: "유창성" },
              { id: 15, task: "저는 공원에서 산책을 합니다", category: "유창성" }, { id: 16, task: "어제는 친구와 영화를 봤어요", category: "유창성" },
              { id: 17, task: "내일은 비가 올 것 같습니다", category: "유창성" }, { id: 18, task: "아이가 공을 차고 있습니다", category: "복합묘사" },
              { id: 19, task: "엄마가 요리를 하고 있습니다", category: "복합묘사" }, { id: 20, task: "다리가 아파서 벤치에 앉아요", category: "복합묘사" }
            ]
          },
          BROCA: { title: "LEVEL 2. 표현장애 개선 (BROCA)", subtitle: "조음 실행증 및 구문 형성 재활", items: [] },
          WERNICKE: { title: "LEVEL 3. 청각이해 (WERNICKE)", subtitle: "청각 이해 증진 및 착어 억제", items: [] },
          CONDUCTION: { title: "LEVEL 4. 전도 실어증 (CONDUCTION)", subtitle: "따라말하기 보완 및 음운 회로 강화", items: [] },
          GLOBAL: { title: "LEVEL 5. 전체 실어증 (GLOBAL)", subtitle: "기초 의사소통 수단 확보 훈련", items: [] },
          ANOMIC: { title: "LEVEL 6. 명칭 실어증 (ANOMIC)", subtitle: "단어인출장애 및 우회 전략 훈련", items: [] }
        };

        Object.keys(CLINICAL_PROTOCOLS).forEach(key => {
          if (CLINICAL_PROTOCOLS[key].items.length === 0) {
            CLINICAL_PROTOCOLS[key].items = CLINICAL_PROTOCOLS.STANDARD.items.map(it => ({ ...it, id: Math.random() }));
          }
        });

        const App = () => {
          const [isRegistered, setIsRegistered] = useState(false);
          const [userInfo, setUserInfo] = useState({ name: '', age: '', gender: '남성 (MALE)', agreed: false });
          const [activeTab, setActiveTab] = useState('dashboard');
          const [isProcessing, setIsProcessing] = useState(false);
          const [clinicalMode, setClinicalMode] = useState('STANDARD');
          const [currentIndex, setCurrentIndex] = useState(0);
          const [timeLeft, setTimeLeft] = useState(10);
          const [metrics, setMetrics] = useState({ latency: "0", precision: "0", accuracy: "0", correlation: "0", icc: "0", stability: "0" });
          const [showReport, setShowReport] = useState(false);
          const [testResults, setTestResults] = useState([]);

          const videoRef = useRef(null);
          const streamRef = useRef(null);

          const { 
              RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, 
              AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
              BarChart, Bar, Cell 
          } = window.Recharts || {};

          const handlePrint = () => { window.print(); };
          const stopCamera = () => {
            if (streamRef.current) { streamRef.current.getTracks().forEach(track => track.stop()); streamRef.current = null; }
            if (videoRef.current) videoRef.current.srcObject = null;
          };
          const handleStop = () => { setIsProcessing(false); stopCamera(); setShowReport(false); };

          useEffect(() => {
            if (!isRegistered) return;
            let interval;
            if (activeTab === 'dashboard' || isProcessing) {
              interval = setInterval(() => {
                setMetrics(prev => ({
                  latency: (31 + Math.random() * 8).toFixed(1),
                  precision: (0.11 + Math.random() * 0.12).toFixed(2),
                  accuracy: (97.1 + Math.random() * 2.5).toFixed(1),
                  correlation: (0.89 + Math.random() * 0.03).toFixed(2),
                  icc: (0.86 + Math.random() * 0.03).toFixed(2),
                  stability: (1.0 + Math.random() * 1.4).toFixed(1)
                }));
              }, 1000);
            }
            return () => clearInterval(interval);
          }, [activeTab, isProcessing, isRegistered]);

          useEffect(() => {
            if (!isProcessing) return;
            let timer;
            if (timeLeft > 0) {
              timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
            } else if (timeLeft === 0) {
              const score = Math.floor(Math.random() * 4) + 6; 
              setTestResults(prev => [...prev, { task: CLINICAL_PROTOCOLS[clinicalMode].items[currentIndex].task, score, hit: score >= 7.5 }]);
              if (currentIndex < 19) {
                setCurrentIndex(p => p + 1);
                setTimeLeft(10);
              } else {
                setIsProcessing(false);
                setShowReport(true);
                stopCamera();
              }
            }
            return () => clearInterval(timer);
          }, [isProcessing, timeLeft, currentIndex, clinicalMode]);

          const generateSampleReport = () => {
            const samples = CLINICAL_PROTOCOLS[clinicalMode].items.map(it => ({
              task: it.task,
              score: (Math.random() * 3 + 7).toFixed(1),
              hit: Math.random() > 0.15
            }));
            setTestResults(samples);
            setMetrics({ latency: "34.5", precision: "0.14", accuracy: "98.2", correlation: "0.91", icc: "0.88", stability: "1.1" });
            setIsProcessing(false);
            setShowReport(true);
            stopCamera();
          };

          const handleStart = async () => {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
              streamRef.current = stream;
              if (videoRef.current) videoRef.current.srcObject = stream;
              setTestResults([]);
              setCurrentIndex(0);
              setTimeLeft(10);
              setShowReport(false);
              setIsProcessing(true);
            } catch (err) {
              alert("카메라를 사용할 수 없습니다.");
            }
          };

          const summary = useMemo(() => {
            if (testResults.length === 0) return null;
            const avg = parseFloat((testResults.reduce((a, b) => a + parseFloat(b.score), 0) / testResults.length).toFixed(1));
            let grade = "하"; let rehab = "주 5일 이상 집중 재활"; let color = "#EF4444";
            if (avg >= 8.5) { grade = "상"; rehab = "주 1-2회 유지 재활"; color = "#10B981"; }
            else if (avg >= 7.0) { grade = "중"; rehab = "주 3-4회 집중 재활"; color = "#F59E0B"; }
            const risk = ((parseFloat(metrics.precision) / 0.5) * 40 + (parseFloat(metrics.latency) / 50) * 30 + (1 - avg/10) * 30).toFixed(1);
            const percentile = (100 - avg * 8.5).toFixed(1);
            return { avg, grade, rehab, color, risk, percentile };
          }, [testResults, metrics]);

          const radarData = [
            { subject: '정확도', A: parseFloat(metrics.accuracy) || 0 },
            { subject: '안면 정밀', A: (1 - (parseFloat(metrics.precision) || 0) / 0.5) * 100 },
            { subject: '지연시간', A: (1 - (parseFloat(metrics.latency) || 0) / 100) * 100 },
            { subject: '임상 상관', A: (parseFloat(metrics.correlation) || 0) * 100 },
            { subject: '신뢰도', A: (parseFloat(metrics.icc) || 0) * 100 },
            { subject: '안정성', A: (1 - (parseFloat(metrics.stability) || 0) / 20) * 100 },
          ];

          // --- 사용자 정보 등록 화면 ---
          if (!isRegistered) {
            return (
              <div className="min-h-screen flex items-center justify-center p-6 bg-[#EDF6FF]">
                <div className="bg-white p-12 rounded-[50px] shadow-2xl w-full max-w-2xl fade-in border-8 border-white">
                  <div className="flex flex-col items-center mb-10 text-center">
                    <div className="p-6 bg-blue-50 rounded-[35px] mb-6 shadow-inner animate-pulse">
                        <Icon name="BrainCircuit" color="#3B82F6" size={64} />
                    </div>
                    <div className="space-y-3">
                        <h1 className="text-4xl font-black text-slate-900 tracking-tighter uppercase">브레인톡톡</h1>
                        <p className="text-blue-600 font-black text-sm uppercase tracking-[0.4em]">Integrated Rehab Hub Solution</p>
                    </div>
                    <div className="mt-8 bg-blue-50/70 p-8 rounded-[35px] border border-blue-100 w-full">
                        <h3 className="text-blue-800 font-black mb-3 flex items-center justify-center gap-2">
                            <Icon name="Stethoscope" size={20} color="#2563EB" /> 진단-훈련 통합형 시스템 가이드
                        </h3>
                        <p className="text-slate-600 text-sm leading-relaxed font-bold">
                            본 시스템은 K-WAB 기반의 디지털 진단 데이터를 분석하여 <br/>
                            환자별 맞춤형 재활 프로그램을 즉시 처방하고 수행하는 <br/>
                            <span className="text-blue-700">전문의료용 통합 언어재활 솔루션</span>입니다.
                        </p>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-8 mb-10">
                    <div className="space-y-5">
                        <div className="space-y-2">
                            <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">피검사자 성함</label>
                            <input type="text" placeholder="성함 입력" value={userInfo.name} onChange={(e) => setUserInfo({...userInfo, name: e.target.value})} className="w-full px-6 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl text-slate-900 font-black focus:border-blue-400 outline-none transition-all placeholder:text-slate-300"/>
                        </div>
                        <div className="space-y-2">
                            <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">피검사자 나이</label>
                            <input type="number" placeholder="나이 입력" value={userInfo.age} onChange={(e) => setUserInfo({...userInfo, age: e.target.value})} className="w-full px-6 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl text-slate-900 font-black focus:border-blue-400 outline-none transition-all placeholder:text-slate-300"/>
                        </div>
                    </div>
                    <div className="space-y-5">
                        <div className="space-y-2">
                            <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">성별 선택</label>
                            <select value={userInfo.gender} onChange={(e) => setUserInfo({...userInfo, gender: e.target.value})} className="w-full px-6 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl text-slate-900 font-black outline-none appearance-none"><option>남성 (MALE)</option><option>여성 (FEMALE)</option></select>
                        </div>
                        <div className="space-y-2">
                            <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-1">데이터 동의</label>
                            <div className="flex items-center gap-4 p-4 bg-blue-50 rounded-2xl border-2 border-blue-100 cursor-pointer h-[60px]" onClick={() => setUserInfo({...userInfo, agreed: !userInfo.agreed})}>
                                <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${userInfo.agreed ? 'bg-blue-600 border-blue-600' : 'border-slate-300 bg-white'}`}>
                                    {userInfo.agreed && <Icon name="Check" size={14} color="white" />}
                                </div>
                                <p className="text-[11px] text-slate-700 font-black leading-tight uppercase">데이터 활용 동의</p>
                            </div>
                        </div>
                    </div>
                  </div>

                  <button 
                    disabled={!userInfo.name || !userInfo.age || !userInfo.agreed} 
                    onClick={() => setIsRegistered(true)} 
                    className="w-full bg-blue-600 text-white py-6 rounded-3xl font-black text-xl shadow-xl shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-20 flex items-center justify-center gap-3"
                  >
                    사용자 등록 및 가동 시작 <Icon name="ArrowRight" size={24} />
                  </button>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen text-slate-800">
              {/* --- 메인 앱 UI (인쇄 시 숨김) --- */}
              <div className="print:hidden p-6 lg:p-10 animate-in fade-in duration-700 max-w-7xl mx-auto">
                <header className="flex justify-between items-center mb-10 bg-white p-6 rounded-[35px] border-2 border-blue-100 shadow-sm">
                  <div className="flex items-center gap-5">
                    <div className="p-4 bg-blue-600 rounded-[22px] shadow-lg"><Icon name="BrainCircuit" color="white" size={32} /></div>
                    <div>
                      <h1 className="text-3xl font-black text-slate-900 tracking-tighter uppercase italic">브레인톡톡</h1>
                      <div className="flex items-center gap-3 mt-1">
                        <span className="bg-blue-50 text-blue-600 text-[10px] font-black px-2 py-0.5 rounded uppercase border border-blue-100">PRO-ELITE</span>
                        <p className="text-slate-400 text-xs font-bold uppercase tracking-widest">Patient: {userInfo.name} ({userInfo.age}세, {userInfo.gender.split(' ')[0]})</p>
                      </div>
                    </div>
                  </div>
                  <div className="flex gap-2 bg-blue-50 p-1.5 rounded-2xl border border-blue-100">
                    <button onClick={() => {setActiveTab('dashboard'); setShowReport(false); handleStop();}} className={`px-8 py-3 rounded-xl text-sm font-black transition-all ${activeTab === 'dashboard' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400 hover:text-blue-600'}`}>통합 대시보드</button>
                    <button onClick={() => {setActiveTab('engine'); setShowReport(false);}} className={`px-8 py-3 rounded-xl text-sm font-black transition-all ${activeTab === 'engine' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400 hover:text-blue-600'}`}>전문 프로토콜</button>
                  </div>
                </header>

                {activeTab === 'dashboard' ? (
                  <div className="grid grid-cols-12 gap-8">
                    <div className="col-span-12 lg:col-span-8 space-y-8">
                      <div className="grid grid-cols-3 gap-6">
                        {[
                          { label: "SYSTEM LATENCY", val: metrics.latency, unit: "ms", icon: "Clock" },
                          { label: "FACIAL TRACKING", val: metrics.precision, unit: "mm", icon: "User" },
                          { label: "AUDIO ACCURACY", val: metrics.accuracy, unit: "%", icon: "Mic" }
                        ].map((m, i) => (
                          <div key={i} className="bg-white p-8 rounded-[40px] border-2 border-blue-50 shadow-sm hover:border-blue-200 transition-all group">
                            <div className="flex justify-between items-center mb-4">
                                <div className="p-3 bg-blue-50 text-blue-600 rounded-2xl group-hover:scale-110 transition-transform"><Icon name={m.icon} size={24} /></div>
                                <span className="text-[10px] font-black text-blue-400 tracking-widest uppercase bg-blue-50 px-2 py-1 rounded-lg">Verified</span>
                            </div>
                            <p className="text-slate-400 text-[11px] font-black uppercase mb-1">{m.label}</p>
                            <div className="flex items-baseline gap-1 font-black text-4xl text-slate-900">{m.val}<span className="text-sm text-slate-300 font-bold">{m.unit}</span></div>
                          </div>
                        ))}
                      </div>
                      <div className="bg-white p-10 rounded-[50px] border-2 border-blue-50 shadow-sm h-[400px] relative overflow-hidden">
                        <h3 className="text-sm font-black mb-10 flex items-center gap-3 text-slate-900 uppercase italic"><Icon name="Activity" size={20} color="#3B82F6" /> Real-time Diagnostic Precision</h3>
                        <ResponsiveContainer width="100%" height="75%">
                          {AreaChart && (
                            <AreaChart data={[...Array(40)].map((_, i) => ({ t: i, v: 95.8 + Math.random() * 3.2 }))}>
                                <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3B82F6" stopOpacity={0.25}/><stop offset="95%" stopColor="#3B82F6" stopOpacity={0}/></linearGradient></defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#F1F5F9" /><XAxis hide /><YAxis domain={[93, 100]} hide /><Area type="monotone" dataKey="v" stroke="#3B82F6" strokeWidth={6} fill="url(#g)" />
                            </AreaChart>
                          )}
                        </ResponsiveContainer>
                      </div>
                    </div>
                    <div className="col-span-12 lg:col-span-4 bg-white p-10 rounded-[50px] border-2 border-blue-50 shadow-sm">
                        <h3 className="text-center font-black mb-12 tracking-[0.3em] text-blue-600 uppercase text-xs">Clinical Maturity Radar</h3>
                        <div className="h-80 mb-10">
                            <ResponsiveContainer width="100%" height="100%">
                                {RadarChart && (
                                    <RadarChart data={radarData}>
                                        <PolarGrid stroke="#F1F5F9" /><PolarAngleAxis dataKey="subject" tick={{ fill: '#64748B', fontSize: 11, fontWeight: 900 }} /><Radar dataKey="A" stroke="#3B82F6" fill="#3B82F6" fillOpacity={0.4} strokeWidth={4} />
                                    </RadarChart>
                                )}
                            </ResponsiveContainer>
                        </div>
                        <div className="p-8 bg-blue-50/50 rounded-[35px] border border-blue-100 shadow-inner">
                            <div className="flex justify-between items-center mb-4 text-[11px] font-black uppercase"><span className="text-blue-700">Stability Index</span><span className="text-emerald-600 font-black">Active Sync</span></div>
                            <div className="w-full bg-white h-3 rounded-full overflow-hidden mb-5 shadow-sm"><div className="bg-blue-600 h-full w-[94%] shadow-[0_0_10px_#3B82F6]"></div></div>
                            <p className="text-[10px] text-slate-500 font-bold leading-relaxed italic text-center">Multi-modal bio-marker synchronization verified.</p>
                        </div>
                    </div>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in slide-in-from-right-4 duration-500">
                    <div className="lg:col-span-4 space-y-6">
                      <div className="bg-white p-8 rounded-[45px] border-4 border-blue-100 shadow-xl">
                        <h3 className="font-black text-blue-700 mb-8 text-2xl text-center uppercase tracking-tighter italic">Selection Hub</h3>
                        <div className="space-y-3 mb-10">
                          {Object.keys(CLINICAL_PROTOCOLS).map(mode => (
                            <button key={mode} onClick={() => {setClinicalMode(mode); setCurrentIndex(0); setTimeLeft(10);}} className={`w-full p-5 rounded-2xl border-2 text-left transition-all ${clinicalMode === mode ? 'border-blue-600 bg-blue-50 shadow-md scale-[1.02]' : 'border-slate-100 bg-slate-50 hover:bg-white hover:border-blue-200'}`}>
                              <p className="font-black text-slate-900 text-base mb-1">{CLINICAL_PROTOCOLS[mode].title}</p>
                              <p className="text-[10px] text-blue-400 uppercase tracking-widest font-black leading-none">{CLINICAL_PROTOCOLS[mode].subtitle}</p>
                            </button>
                          ))}
                        </div>
                        <div className="flex flex-col gap-4">
                          {!isProcessing ? (
                            <>
                              <button onClick={handleStart} className="w-full bg-blue-600 text-white py-6 rounded-3xl font-black text-xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-3"><Icon name="Play" fill="white" /> 가동 시작</button>
                              <button onClick={generateSampleReport} className="w-full bg-white text-blue-600 py-4 rounded-2xl font-black text-sm hover:bg-blue-50 transition-all flex items-center justify-center gap-2 border-2 border-blue-100"><Icon name="Eye" size={20} /> 샘플 리포트 즉시 생성</button>
                            </>
                          ) : (
                            <button onClick={handleStop} className="w-full bg-rose-600 text-white py-6 rounded-3xl font-black text-xl animate-pulse flex items-center justify-center gap-3 shadow-xl"><Icon name="Square" fill="white" /> 긴급 중단</button>
                          )}
                        </div>
                      </div>
                      <div className="bg-black rounded-[45px] aspect-[4/3] relative overflow-hidden shadow-2xl border-8 border-white">
                        <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover mirror opacity-80" />
                        {isProcessing && <div className="absolute inset-0 border-[12px] border-blue-400/20 rounded-[40px] animate-pulse shadow-inner"></div>}
                        <div className="absolute top-6 left-6 bg-blue-600 text-white px-4 py-2 rounded-2xl text-[11px] font-black uppercase tracking-widest flex items-center gap-2 shadow-xl border border-white/20"><Icon name="Scan" size={16} /> Tracking Active</div>
                      </div>
                    </div>

                    <div className="lg:col-span-8 bg-white rounded-[65px] p-16 shadow-2xl border-4 border-blue-50 flex flex-col justify-center items-center text-center">
                        {isProcessing ? (
                          <div className="fade-in w-full max-w-2xl">
                            <span className="bg-blue-50 text-blue-700 px-8 py-3 rounded-full text-sm font-black uppercase mb-12 inline-block tracking-[0.2em] border-2 border-blue-100">Assessment Module: {currentIndex + 1} / 20</span>
                            <h4 className="text-slate-400 font-black uppercase text-xl mb-6 tracking-widest">{CLINICAL_PROTOCOLS[clinicalMode].items[currentIndex].category}</h4>
                            <h2 className="text-[110px] font-black text-slate-900 mb-20 tracking-tighter leading-none font-black drop-shadow-sm">"{CLINICAL_PROTOCOLS[clinicalMode].items[currentIndex].task}"</h2>
                            <div className="w-64 h-64 relative flex items-center justify-center mx-auto">
                              <svg className="w-full h-full transform -rotate-90"><circle cx="50%" cy="50%" r="45%" stroke="#F1F5F9" strokeWidth="20" fill="transparent" /><circle cx="50%" cy="50%" r="45%" stroke="#3B82F6" strokeWidth="20" fill="transparent" strokeDasharray="283" strokeDashoffset={283 - (283 * timeLeft) / 10} className="transition-all duration-1000 ease-linear shadow-sm" /></svg>
                              <div className="absolute flex flex-col items-center"><span className="text-8xl font-black text-slate-900 leading-none font-bold">{timeLeft}</span><span className="text-xs font-black text-blue-500 tracking-[0.4em] uppercase mt-3">Seconds</span></div>
                            </div>
                          </div>
                        ) : !showReport ? (
                          <div className="opacity-30 flex flex-col items-center py-20">
                             <div className="p-12 bg-blue-50 rounded-[65px] mb-12"><Icon name="ClipboardList" size={130} color="#3B82F6" /></div>
                             <h3 className="text-5xl font-black text-slate-900 mb-6 tracking-tighter italic uppercase">Pro-Engine Hub</h3>
                             <p className="text-slate-500 font-bold text-xl uppercase tracking-widest font-black uppercase">프로토콜을 선택하고 훈련을 시작하십시오.</p>
                          </div>
                        ) : (
                          /* --- 화면 리포트 미리보기 --- */
                          <div className="w-full text-left fade-in overflow-y-auto max-h-[85vh] px-6 custom-scroll py-4">
                             <div className="flex justify-between items-end border-b-8 border-blue-600 pb-12 mb-12">
                                <div>
                                    <h2 className="text-7xl font-black text-slate-900 tracking-tighter italic uppercase mb-2 font-black">Report Result</h2>
                                    <p className="text-blue-600 font-black text-sm uppercase tracking-[0.4em] font-black uppercase">Integrated Prognosis Engine Hub</p>
                                </div>
                                <button onClick={handlePrint} className="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-6 rounded-[35px] font-black text-lg flex items-center gap-4 shadow-xl active:scale-95 transition-all"><Icon name="Printer" size={28} /> SAVE METADATA (PDF)</button>
                             </div>

                             <div className="grid grid-cols-3 gap-8 mb-12">
                                <div className="bg-blue-50/50 p-10 rounded-[55px] border-2 border-blue-100 text-center flex flex-col items-center justify-center shadow-inner">
                                   <p className="text-slate-400 text-xs font-black uppercase mb-6 tracking-widest font-black uppercase">종합 성취 등급</p>
                                   <span className="text-[140px] font-black leading-none mb-6 font-black font-black" style={{color: summary?.color}}>{summary?.grade}</span>
                                   <div className="px-8 py-3 rounded-full bg-white border-2 border-blue-100 text-sm font-black uppercase text-blue-700 font-black uppercase">평균 {summary?.avg} 점</div>
                                </div>
                                <div className="bg-blue-50/50 p-10 rounded-[55px] border-2 border-blue-100 text-center flex flex-col items-center justify-center shadow-inner">
                                   <Icon name="CalendarCheck" size={64} color="#3B82F6" className="mb-10" />
                                   <p className="text-slate-400 text-xs font-black uppercase mb-4 tracking-widest font-black uppercase font-black uppercase font-black uppercase">재활 권고 주기</p>
                                   <h4 className="text-3xl font-black text-slate-900 leading-tight uppercase font-black font-black">{summary?.rehab}</h4>
                                </div>
                                <div className={`p-10 rounded-[55px] border-2 text-center flex flex-col items-center justify-center shadow-inner transition-all ${parseFloat(summary?.risk) > 50 ? 'bg-rose-50 border-rose-300 animate-pulse' : 'bg-blue-50/50 border-blue-100'}`}>
                                   <Icon name="AlertTriangle" size={64} color={parseFloat(summary?.risk) > 50 ? '#E11D48' : '#3B82F6'} className="mb-10" />
                                   <p className="text-slate-400 text-xs font-black uppercase mb-4 tracking-widest font-black uppercase uppercase font-black uppercase">뇌졸중 위험 인덱스</p>
                                   <span className="text-7xl font-black text-slate-900 font-black leading-none font-black">{summary?.risk}%</span>
                                </div>
                             </div>
                             <div className="bg-white p-10 rounded-[45px] border-4 border-blue-100 mb-10 shadow-sm">
                                <h3 className="text-blue-700 font-black text-sm uppercase tracking-widest mb-8 flex items-center gap-3 italic"><Icon name="ShieldCheck" size={24} /> Preview Complete</h3>
                                <p className="text-slate-600 font-bold text-xl leading-relaxed font-black">
                                    훈련 분석이 종료되었습니다. 위 등급을 확인하시고, 상세 분석과 전문가의 맞춤형 소견이 포함된 <strong>A4 2장 분량의 전문 리포트</strong>를 생성하여 의료진에게 제출하십시오.
                                </p>
                             </div>
                          </div>
                        )}
                    </div>
                  </div>
                )}
              </div>

              {/* --- 인쇄 전용 레이아웃 (A4 2장 고해상도) --- */}
              {/* 1페이지: 핵심 점수 요약 */}
              <div className="hidden print:block report-page">
                <div className="flex justify-between items-center border-b-8 border-slate-900 pb-8 mb-12">
                  <h1 className="text-[52px] font-black tracking-tighter uppercase leading-none font-black font-black">임상 정밀 진단 및 예후 리포트</h1>
                  <div className="text-right leading-tight">
                    <p className="text-xl font-black uppercase tracking-widest text-slate-900 font-black">BrainTalkTalk Hub</p>
                    <p className="text-xs text-slate-400 mt-2 font-bold font-black">{new Date().toLocaleString()}</p>
                  </div>
                </div>

                <div className="mb-10 p-10 bg-slate-50 border-4 border-slate-200 rounded-[50px] grid grid-cols-3 gap-12 shadow-sm">
                    <div className="flex flex-col"><span className="text-xs font-black text-slate-500 uppercase tracking-widest mb-3 font-black">성명 (NAME)</span><span className="text-4xl font-black text-slate-900 font-black">{userInfo.name}</span></div>
                    <div className="flex flex-col"><span className="text-xs font-black text-slate-500 uppercase tracking-widest mb-3 font-black">나이 (AGE)</span><span className="text-4xl font-black text-slate-900 font-black">{userInfo.age}세</span></div>
                    <div className="flex flex-col"><span className="text-xs font-black text-slate-500 uppercase tracking-widest mb-3 font-black">성별 (GENDER)</span><span className="text-4xl font-black text-slate-900 font-black">{userInfo.gender.split(' ')[0]}</span></div>
                </div>

                <div className="grid grid-cols-3 gap-8 mb-14 h-72">
                  <div className="border-4 border-slate-900 p-12 rounded-[60px] text-center flex flex-col justify-center shadow-md">
                    <h4 className="text-xs font-black uppercase text-slate-500 mb-6 tracking-widest font-black uppercase">종합 성취 등급</h4>
                    <span className="text-[120px] font-black leading-none text-slate-900 font-black">{summary?.grade}</span>
                    <p className="mt-8 font-black text-3xl text-slate-900 uppercase font-black font-black">평균 {summary?.avg} 점</p>
                  </div>
                  <div className="border-4 border-slate-900 p-12 rounded-[60px] text-center flex flex-col items-center justify-center shadow-md">
                    <h4 className="text-xs font-black uppercase text-slate-500 mb-10 tracking-widest font-black uppercase">재활 권고 주기</h4>
                    <div className="bg-slate-100 p-8 rounded-[40px] border-2 border-slate-200 w-full font-black text-slate-900 text-3xl leading-tight font-black font-black uppercase leading-tight font-black">{summary?.rehab}</div>
                  </div>
                  <div className={`border-4 p-12 rounded-[60px] text-center flex flex-col justify-center shadow-md ${parseFloat(summary?.risk) > 50 ? 'border-red-600 bg-red-50' : 'border-slate-900'}`}>
                    <h4 className="text-xs font-black uppercase text-slate-500 mb-6 tracking-widest font-black uppercase uppercase font-black uppercase">뇌졸중 위험 인덱스</h4>
                    <span className="text-[100px] font-black text-slate-900 font-black leading-none font-black">{summary?.risk}%</span>
                  </div>
                </div>

                <div className="mb-10">
                  <h4 className="text-2xl font-black border-b-4 border-slate-300 mb-10 pb-3 uppercase tracking-[0.2em] font-black font-black font-black font-black uppercase font-black">SECTION 3. 20문항 정밀 데이터 카드 (Scorecard)</h4>
                  <div className="grid grid-cols-5 gap-4">
                    {testResults.map((r, i) => (
                      <div key={i} className="border-2 border-slate-200 p-5 rounded-[30px] flex flex-col gap-2 bg-slate-50 shadow-sm">
                        <div className="flex justify-between text-[11px] font-black uppercase leading-none mb-1 font-black uppercase font-black"><span className="text-slate-400">ITEM #{i+1}</span><span className={r.hit ? "text-emerald-600 font-black" : "text-rose-600 font-black"}>{r.hit ? "HIT" : "MISS"}</span></div>
                        <div className="font-black text-base truncate uppercase text-slate-800 leading-tight mb-2 font-black font-black">{r.task}</div>
                        <div className="text-right text-3xl font-black text-blue-900 leading-none font-black font-black">{r.score}<span className="text-xs text-slate-400 font-bold ml-1">/10</span></div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="mt-auto pt-10 border-t-4 border-slate-100 flex justify-between items-center text-sm font-black text-slate-400 uppercase tracking-widest font-black">
                   <p>본 결과는 전문 의료진의 참고 자료로 활용되며 법적 효력은 진단 기준에 따릅니다. (1/2)</p>
                   <div className="flex items-center gap-2 font-black italic font-black uppercase font-black uppercase font-black"><Icon name="Award" size={24} /> GOLDEN BRAINCARE INC.</div>
                </div>
              </div>

              {/* 2페이지: 상세 분석 및 임상 소견 */}
              <div className="hidden print:block report-page">
                <div className="flex justify-between items-center border-b-8 border-slate-900 pb-8 mb-14">
                   <h2 className="text-[48px] font-black tracking-tighter uppercase font-black font-black font-black font-black uppercase">정밀 임상 데이터 분석 및 소견</h2>
                   <div className="text-right leading-tight font-black font-black uppercase"><p className="text-lg font-bold text-slate-500 font-black">P-ID: {userInfo.name.charAt(0)}*{userInfo.name.slice(2)}_{userInfo.age}</p></div>
                </div>

                <div className="mb-20">
                    <h4 className="text-2xl font-black border-b-4 border-slate-300 mb-14 pb-4 uppercase tracking-[0.2em] font-black font-black uppercase font-black font-black">임상 지표 성숙도 분석 (Radar Analysis)</h4>
                    <div className="flex items-center justify-center h-[550px] w-full mx-auto p-10 bg-slate-50 rounded-[60px] border-2 border-slate-100 shadow-inner">
                        <ResponsiveContainer width="95%" height="100%">
                            {RadarChart && (
                                <RadarChart data={radarData}>
                                    <PolarGrid stroke="#CBD5E1" strokeWidth={2} />
                                    <PolarAngleAxis dataKey="subject" tick={{ fill: '#1E293B', fontSize: 18, fontWeight: 900 }} />
                                    <Radar dataKey="A" stroke="#2563EB" fill="#3B82F6" fillOpacity={0.45} strokeWidth={8} />
                                </RadarChart>
                            )}
                        </ResponsiveContainer>
                    </div>
                </div>

                <div className="border-t-8 border-slate-900 pt-16 mt-auto relative">
                  <h4 className="text-3xl font-black mb-12 italic text-slate-900 uppercase tracking-widest font-black uppercase font-black font-black font-black uppercase font-black font-black uppercase">임상 전문가 종합 소견 (SLP Clinical Insight)</h4>
                  <div className="border-l-[16px] border-slate-900 pl-12 py-12 bg-slate-50 rounded-r-[70px] shadow-xl border-y border-r border-slate-200">
                    <p className="text-[30px] font-black leading-[1.8] tracking-tight text-slate-800 font-black font-black font-black font-black font-black leading-relaxed">
                       본 세션 분석 결과, 환자 <strong>{userInfo.name}</strong> 님의 조음 정확도 및 낱말 인출 능력은 K-WAB 정상군 규준 대비 상위 { summary?.percentile }% 수준으로 <strong>'{summary?.grade}'</strong> 등급 판정되었습니다. 
                       <br/><br/>
                       특히 안면 비대칭 편차와 발화 잠복기(Latency) 데이터를 종합할 때 <strong>뇌졸중 위험 지수는 {summary?.risk}%</strong>로 기록되었습니다. {parseFloat(summary?.risk) > 50 ? "미세한 마비 징후가 의심되는 고위험 상태이므로 즉각적인 신경학적 정밀 검진을 권고합니다." : "현재 비교적 안정적인 신경학적 상태를 유지하고 있는 것으로 판단됩니다."}
                    </p>
                  </div>
                  <div className="mt-16 flex items-center gap-6 text-emerald-700 font-black text-3xl uppercase tracking-widest font-black uppercase font-black font-black font-black font-black font-black"><Icon name="CheckCircle" size={48} color="#059669" /> Diagnostic Reliability Verified (R ≥ 0.89)</div>
                </div>

                <div className="mt-auto pt-10 border-t-4 border-slate-100 flex justify-between items-center text-sm font-black text-slate-400 uppercase tracking-widest font-black font-black font-black">
                   <p>본 리포트의 지적 재산권은 Golden Braincare INC.에 있습니다. (2/2)</p>
                   <div className="flex items-center gap-2 font-black italic uppercase font-black uppercase font-black uppercase font-black uppercase font-black"><Icon name="Award" size={24} /> Golden Braincare INC.</div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
